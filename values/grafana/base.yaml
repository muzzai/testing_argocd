# Grafana base values
# NOTE: Before first deploy, create these secrets manually:
#   kubectl -n monitoring create secret generic grafana-admin-credentials \
#     --from-literal=admin-user=admin \
#     --from-literal=admin-password=<YOUR_PASSWORD>
#
#   kubectl -n monitoring create secret generic grafana-teams-webhook \
#     --from-literal=webhook-url=<TEAMS_WEBHOOK_URL>
admin:
  existingSecret: grafana-admin-credentials
  userKey: admin-user
  passwordKey: admin-password

persistence:
  enabled: true
  accessModes:
    - ReadWriteOnce
  size: 5Gi

datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: VictoriaMetrics
        uid: victoria-metrics
        type: prometheus
        url: http://vmc-victoria-metrics-cluster-vmselect.monitoring.svc.cluster.local:8481/select/0/prometheus/
        access: proxy
        isDefault: true
        jsonData:
          timeInterval: 30s
      - name: VictoriaLogs
        uid: victoria-logs
        type: victoriametrics-logs-datasource
        url: http://vlc-victoria-logs-cluster-vlselect.monitoring.svc.cluster.local:9471/
        access: proxy
        jsonData:
          maxLines: 1000

env:
  GF_INSTALL_PLUGINS: "victoriametrics-logs-datasource"

envValueFrom:
  TEAMS_WEBHOOK_URL:
    secretKeyRef:
      name: grafana-teams-webhook
      key: webhook-url

ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
  hosts:
    - grafana.example.com
  tls:
    - secretName: grafana-tls
      hosts:
        - grafana.example.com

sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard

# â”€â”€ Alerting: notification templates, contact points, policies, rules â”€â”€
alerting:
  templates.yaml:
    apiVersion: 1
    templates:
      - orgId: 1
        name: teams_adaptive_card
        template: |
          {{ define "teams.adaptive_card" -}}
          {{ $alert := (index .Alerts 0) -}}
          {
            "type": "message",
            "attachments": [{
              "contentType": "application/vnd.microsoft.card.adaptive",
              "contentUrl": null,
              "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.4",
                "msteams": {"width": "Full"},
                "body": [
                  {
                    "type": "TextBlock",
                    "size": "Large",
                    "weight": "Bolder",
                    "color": "{{ if eq $alert.Status "firing" }}Attention{{ else }}Good{{ end }}",
                    "text": "{{ if eq $alert.Status "firing" }}ðŸ”´ Host {{ $alert.Labels.instance }} IS DOWN!{{ else }}âœ… Host {{ $alert.Labels.instance }} IS UP{{ end }}"
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {"title": "Instance", "value": "{{ $alert.Labels.instance }}"},
                      {"title": "Job", "value": "{{ $alert.Labels.job }}"},
                      {"title": "Severity", "value": "{{ $alert.Labels.severity }}"},
                      {"title": "Status", "value": "{{ $alert.Status }}"},
                      {"title": "Started", "value": "{{ $alert.StartsAt }}"}
                    ]
                  },
                  {
                    "type": "TextBlock",
                    "text": "{{ $alert.Annotations.summary }}",
                    "wrap": true,
                    "spacing": "Medium"
                  }
                ],
                "actions": [
                  {
                    "type": "Action.OpenUrl",
                    "title": "ðŸ”— View Alert",
                    "url": "{{ $alert.GeneratorURL }}"
                  },
                  {
                    "type": "Action.OpenUrl",
                    "title": "ðŸ”‡ Silence Alert",
                    "url": "{{ $alert.SilenceURL }}"
                  }
                ]
              }
            }]
          }
          {{- end }}

  contactpoints.yaml:
    apiVersion: 1
    contactPoints:
      - orgId: 1
        name: microsoft-teams
        receivers:
          - uid: teams-webhook
            type: webhook
            settings:
              url: ${TEAMS_WEBHOOK_URL}
              httpMethod: POST
              maxAlerts: "1"
              message: '{{ template "teams.adaptive_card" . }}'
            disableResolveMessage: false

  policies.yaml:
    apiVersion: 1
    policies:
      - orgId: 1
        receiver: microsoft-teams
        group_by:
          - grafana_folder
          - alertname

  rules.yaml:
    apiVersion: 1
    groups:
      - orgId: 1
        name: windows-exporter
        folder: Infrastructure
        interval: 1m
        rules:
          - uid: host-down
            title: HostDown
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: victoria-metrics
                model:
                  refId: A
                  expr: up{job="windows_exporter"}
                  instant: true
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: B
                relativeTimeRange:
                  from: 3600
                  to: 0
                datasourceUid: victoria-metrics
                model:
                  refId: B
                  expr: max_over_time(up{job="windows_exporter"}[1h])
                  instant: true
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  refId: C
                  type: math
                  expression: "$A == 0 && $B == 1"
            noDataState: OK
            execErrState: Error
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Host {{ $labels.instance }} IS DOWN!"
              description: "Host {{ $labels.instance }} (job={{ $labels.job }}) has been down for more than 2 minutes. The host was up within the past hour."
